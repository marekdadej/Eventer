@model IEnumerable<Eventer.Models.Event>

@{
    ViewData["Title"] = "Moje Zapisane Wydarzenia";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    body {
        background-color: #121212 !important;
        color: #e0e0e0 !important;
    }

    .container {
        max-width: 1600px !important; 
        width: 100%;
        margin: 0 auto;
        padding-top: 20px;
    }

    :root {
        --bg-panel: #1e1e1e;
        --bg-input: #2d2d2d;
        --accent: #ffc107;
        --accent-hover: #ffca2c;
        --text-main: #e0e0e0;
        --text-muted: #a0a0a0;
        --border: #333;
        --radius: 6px;
        --transition: all 0.2s ease;
    }

    h2 {
        color: var(--accent);
        border-bottom: 1px solid var(--border);
        padding-bottom: 15px;
        margin-bottom: 30px;
        text-transform: uppercase;
        font-weight: 800;
        font-size: 1.5rem;
    }

    .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 25px;
    }

    .event-card {
        background-color: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        transition: transform 0.3s ease, border-color 0.3s ease;
    }

    .event-card:hover {
        transform: translateY(-5px);
        border-color: var(--accent);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .card-img-wrap {
        height: 200px;
        width: 100%;
        background-color: #000;
        position: relative;
        cursor: pointer;
        overflow: hidden;
    }

    .card-img-wrap img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: opacity 0.3s, transform 0.5s;
    }

    .card-img-wrap:hover img {
        opacity: 0.4;
        transform: scale(1.05);
    }

    .view-btn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: var(--accent);
        color: #000;
        font-weight: 800;
        padding: 10px 20px;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.3s, transform 0.3s;
        pointer-events: none;
        text-transform: uppercase;
        font-size: 0.85rem;
    }

    .card-img-wrap:hover .view-btn {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }

    .card-body {
        padding: 15px;
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .card-date {
        color: var(--accent);
        font-size: 0.8rem;
        margin-bottom: 10px;
        opacity: 0.8;
    }

    .card-details {
        font-size: 0.85rem;
        color: #aaa;
        line-height: 1.6;
        border-top: 1px solid #333;
        padding-top: 10px;
    }

    .actions-wrap {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        display: flex;
        gap: 8px;
    }

    .action-btn {
        background: rgba(0, 0, 0, 0.7);
        border-radius: 4px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        text-decoration: none;
        backdrop-filter: blur(4px);
    }

    .btn-edit { color: var(--accent); border-color: rgba(255, 193, 7, 0.3); }
    .btn-edit:hover { background: var(--accent); color: #000; }

    .btn-delete { color: #ff4444; border-color: rgba(255, 68, 68, 0.3); }
    .btn-delete:hover { background: #ff4444; color: #fff; }

    .modal-overlay {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.95);
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }

    .modal-content-3d {
        width: 95%;
        height: 90%;
        background: #111;
        border: 1px solid var(--accent);
        position: relative;
        box-shadow: 0 0 50px rgba(255, 193, 7, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .close-modal {
        position: absolute;
        top: 20px;
        right: 30px;
        color: #fff;
        font-size: 40px;
        font-weight: 300;
        cursor: pointer;
        z-index: 2001;
        line-height: 0.5;
        transition: color 0.2s;
    }
    .close-modal:hover { color: var(--accent); }

    #viewer3D { width: 100%; height: 100%; display: block; outline: none; }

    .loading-info {
        position: absolute;
        bottom: 20px;
        left: 20px;
        color: #aaa;
        font-size: 0.8rem;
        background: rgba(0,0,0,0.7);
        padding: 5px 12px;
        pointer-events: none;
        border-radius: 4px;
    }
    
    .btn-create-new {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background-color: var(--accent);
        color: #000;
        padding: 10px 20px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 700;
        margin-top: 20px;
        transition: var(--transition);
    }
    .btn-create-new:hover { background-color: var(--accent-hover); color: #000; }
</style>

<div class="container">
    <h2>Twoje zapisane projekty</h2>
    
    <div class="events-grid">
        @if (Model != null && Model.Any())
        {
            foreach (var item in Model)
            {
                <div class="event-card">
                    
                    <div class="actions-wrap">
                        <a href="/Events/Edit/@item.Id" class="action-btn btn-edit" title="Edytuj projekt">
                            <i class="bi bi-pencil-fill"></i>
                        </a>
                        
                        <form asp-action="Delete" asp-route-id="@item.Id" method="post" onsubmit="return confirm('Czy na pewno usunąć?');" style="margin:0;">
                            <button type="submit" class="action-btn btn-delete" title="Usuń projekt">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>

                    <div class="card-img-wrap" onclick="openModal(this)" data-event='@Json.Serialize(item)'>
                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                        {
                            <img src="@item.ImageUrl" alt="Wizualizacja" />
                        }
                        else
                        {
                            <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#555; flex-direction:column;">
                                <i class="bi bi-image" style="font-size:2rem; margin-bottom:10px;"></i>
                                <span>Brak Podglądu</span>
                            </div>
                        }
                        <div class="view-btn"><i class="bi bi-box-seam"></i> Otwórz 3D</div>
                    </div>

                    <div class="card-body">
                        <div class="card-title" title="@item.Name">@item.Name</div>
                        <div class="card-date">
                            <i class="bi bi-calendar3"></i> @item.CreatedDate.ToString("dd.MM.yyyy") 
                            <span style="margin:0 5px; opacity:0.3">|</span> 
                            <i class="bi bi-clock"></i> @item.CreatedDate.ToString("HH:mm")
                        </div>
                        <div class="card-details">
                            Typ: <strong style="color:var(--accent)">@item.MainType</strong><br/>
                            Podłoga: @item.StageWidth x @item.StageDepth m<br/>
                            Dach: @(item.IncludeRoof ? item.RoofType : "Brak")
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div style="grid-column: 1/-1; text-align:center; padding: 80px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px dashed #444;">
                <h3 style="color:#bbb; margin-top:0;">Brak zapisanych projektów.</h3>
                <p style="color:#666; margin-bottom:20px;">Stwórz swój pierwszy projekt sceny 3D.</p>
                <a href="/Events/Create" class="btn-create-new">
                    <i class="bi bi-plus-lg"></i> Stwórz nowy projekt
                </a>
            </div>
        }
    </div>
</div>

<div id="vizModal" class="modal-overlay">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <div class="modal-content-3d">
        <div id="viewer3D"></div>
        <div class="loading-info">
            <i class="bi bi-info-circle"></i> Podgląd interaktywny
        </div>
    </div>
</div>

<script type="module">
    import { initApp, updateSceneData, setEnvironment } from '/js/3d/main.js?v=@DateTime.Now.Ticks';

    window.openModal = function(element) {
        const rawData = element.getAttribute('data-event');
        if (!rawData) return;

        let dbData = {};
        try {
            dbData = JSON.parse(rawData);
        } catch (e) {
            console.error("Błąd parsowania JSON:", e);
            return;
        }

        const modal = document.getElementById('vizModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        const getVal = (key) => {
            if (dbData[key] !== undefined) return dbData[key];
            const lowerKey = key.charAt(0).toLowerCase() + key.slice(1);
            if (dbData[lowerKey] !== undefined) return dbData[lowerKey];
            const upperKey = key.charAt(0).toUpperCase() + key.slice(1);
            if (dbData[upperKey] !== undefined) return dbData[upperKey];
            return undefined;
        };

        try {
            initApp('viewer3D');

            const config = {
                MainType: getVal('MainType'),
                envMode: getVal('EnvMode') || 'mono',
                floorType: getVal('FloorType') || 'layher',
                StageWidth: getVal('StageWidth'),
                StageDepth: getVal('StageDepth'),
                StageHeight: getVal('StageHeight'),
                showMausery: getVal('ShowMausery'),

                includeRoof: getVal('IncludeRoof'),
                roofType: getVal('RoofType') || 'prolyte',
                prolyteVariant: getVal('ProlyteVariant'),
                roofClearance: getVal('RoofClearance'),
                prolyteScrim: getVal('ProlyteScrim'),
                addBallast: getVal('AddBallast'),
                wingWidthBays: getVal('WingWidthBays'),
                
                layherRoofHeight: getVal('LayherRoofHeight'),
                layherRoofSlope: getVal('LayherRoofSlope'),
                layherScrim: getVal('LayherScrim'),

                includeFoh: getVal('IncludeFoh'),
                fohType: getVal('FohType'),
                fohWidth: getVal('FohWidth'),
                fohDepth: getVal('FohDepth'),
                fohDist: getVal('FohDist'),
                fohTower: getVal('FohTower'),
                towerDepth: getVal('TowerDepth'),
                towerHeight: getVal('TowerHeight'),

                catwalkType: getVal('CatwalkType'),
                catwalkDepth: getVal('CatwalkDepth'),
                riserCount: getVal('RiserCount'),
                riserSide: getVal('RiserSide'),
                riserWidth: getVal('RiserWidth'),
                riserDepth: getVal('RiserDepth')
            };

            console.log("Wczytana konfiguracja:", config);
            updateSceneData(config);

        } catch(e) {
            console.error("Błąd 3D:", e);
            alert("Błąd ładowania podglądu.");
        }
    }

    window.closeModal = function() {
        const modal = document.getElementById('vizModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === "Escape") window.closeModal();
    });
</script>